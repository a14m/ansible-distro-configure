---
- name: "Include OS-specific variables"
  ansible.builtin.include_vars: "{{ ansible_facts['os_family'] | lower }}.yml"

- name: "Check if uv binary exists"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin/uv"
  register: python_uv_binary

- name: "Download uv installer"
  ansible.builtin.get_url:
    url: "https://astral.sh/uv/install.sh"
    dest: "/tmp/install_uv.sh"
    mode: "0755"
  when: not python_uv_binary.stat.exists

- name: "Run uv installer"
  ansible.builtin.command:
    cmd: "/tmp/install_uv.sh"
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/bin/uv"
  when: not python_uv_binary.stat.exists

- name: "Symlink uv to /usr/local/bin"
  become: true
  ansible.builtin.file:
    src: "{{ ansible_facts['env']['HOME'] }}/.local/bin/uv"
    dest: "/usr/local/bin/uv"
    state: "link"

- name: "Add uv to shell profile"
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    state: "present"
    prepend_newline: true
    append_newline: true
    marker: "# ==== {mark} ANSIBLE PATH CONFIG"
    block: |
      if [ -d "$HOME/.local/bin" ]; then
        export PATH="$HOME/.local/bin:$PATH"
      fi

- name: "Install python versions"
  ansible.builtin.command:
    cmd: "uv python install {{ item }}"
  register: python_install_result
  changed_when: "'already installed' not in python_install_result.stderr"
  loop: "{{ python_versions }}"
  when: python_versions | length > 0
