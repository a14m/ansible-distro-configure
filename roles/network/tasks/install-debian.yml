---
- name: "Ensure network_packages are installed"
  become: true
  ansible.builtin.apt:
    pkg: "{{ network_packages }}"
    state: "present"
    update_cache: true
  tags: [required_for_boot]

- name: "Set network_default_services facts"
  ansible.builtin.set_fact:
    network_default_services:
      - "dhcpcd"
      - "avahi-daemon"
      - "networking"
      - "wpa_supplicant"
  tags: [required_for_boot]

- name: "Stop/Disable conflicting services"
  become: true
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    enabled: false
    state: "stopped"
  with_items: "{{ network_default_services }}"
  when: not ansible_is_chroot
  failed_when: false
  # Not required for boot
  tags: []

- name: "(chroot): Disable conflicting services"
  ansible.builtin.command:
    cmd: "systemctl disable {{ network_default_services | join(' ') }}"
  changed_when: true
  when: ansible_is_chroot
  # noqa: command-instead-of-module module doesn't work inside chroot
  tags: [required_for_boot]

- name: "Ensure avahi packages are removed"
  become: true
  ansible.builtin.apt:
    pkg:
      - "avahi-daemon"
      - "avahi-utils"
    state: "absent"
    autoremove: true
    purge: true
  tags: [required_for_boot]
